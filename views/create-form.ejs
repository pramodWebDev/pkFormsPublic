<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title> Create Form | pkForms </title>
    <meta name="description" content="Responsive, Bootstrap, BS4" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="/userui/assets/css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="/userui/assets/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="/userui/assets/css/style.css" type="text/css" />
    <link rel="stylesheet" href="/userui/assets/css/jeevan.css" type="text/css" />
    <script src="https://use.fontawesome.com/b37de17474.js"></script>

</head>

<body>

    <div id="" class="layout-column flex">
        <%- include("partials/header.ejs") %>

            <div class="layout-column flex">

                <div class="page-margin-main-vp">
                        <div class="row ">
                            <div class="col-md-9">
                                <div class="modal-title">Custom Form
                                    <br><small>( Enter your own questions )</small>
                                </div>
                            </div>
                            <div class="col-md-3">

                                <button type="button"
                                    class="btn btn-primary mt-4 ml-3 btn-vidpipe-width create_custom_form"> Publish Form
                                </button>
                            </div>
                        </div>
                        <div class="border-vf-custom-form">
                            <label for="formHeading">Form Heading</label>
                            <input type="text" class="form-control mb-4 input-group-sm" id="formHeading" value=""
                                placeholder="Enter Your Form Heading Here...">
                            <div id="formBlock" class="vf-cform-height">

                                <!-- Jquery Code Embedded Here -->
                            </div>
                            <div class="justify-content-center text-center">
                                <button type="button" class="btn btn-primary mt-4 ml-3 text-center btn-vidpipe-width"
                                    id="add_ques_btn"> Add New Row </button>


                            </div>
                        </div>




                  


                </div>
                <!-- ############ Main END-->
            </div>


            <!-- </div> -->

    </div>
    <footer>
        <%- include("partials/footer.ejs") %>

    </footer>


    <script src="/userui/libs/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="/userui/libs/popper.js/dist/umd/popper.min.js"></script>
    <script src="/userui/libs/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- ajax page -->
    <script src="/userui/libs/pjax/pjax.min.js"></script>
    <script src="/userui/assets/js/ajax.js"></script>
    <!-- lazyload plugin -->
    <script src="/userui/assets/js/lazyload.config.js"></script>
    <script src="/userui/assets/js/lazyload.js"></script>
    <script src="/userui/assets/js/plugin.js"></script>
    <!-- scrollreveal -->
    <script src="/userui/libs/scrollreveal/dist/scrollreveal.min.js"></script>
    <!-- feathericon -->
    <script src="/userui/libs/feather-icons/dist/feather.min.js"></script>
    <script src="/userui/assets/js/plugins/feathericon.js"></script>
    <!-- theme -->
    <script src="/userui/assets/js/theme.js"></script>
    <script src="/userui/assets/js/utils.js"></script>
    <!-- endbuild -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>


    
    <script>

        var user_id = <%-JSON.stringify(user_id)%>;

        console.log(user_id, "userid")

        $("#add_ques_btn").on('click', function() {
            var listItemToAdd = makeForm();
            $("#formBlock").append(listItemToAdd);


        })

        $(".make-form-btn").on('click', function() {


            console.log(allWidgetData, "allWidgetDataallWidgetData");
            // renderEditForm();
            $("#formOff").trigger('click');
            $('#formOn').prop("checked", false);
            $('#formOff').prop("checked", true);


            if (allWidgetData.hasOwnProperty('form_custom_questions')) {
                form_custom_questions = allWidgetData.form_custom_questions;

                if (form_custom_questions.length > 0) {
                    renderEditForm();
                }
            }

        })


        function makeForm() {
            var qcount = $("#formBlock").children().length;

            var data = []

            data.push(
                `<div class="form-inline mb-3 mt-3 newRowQuestVform">
                                                                        <div class="form-group mb-2 mr-2 ml-2">
                                                                                <label class="mb-2">  Field ${qcount + 1}  </label>
                                                                            <input type="text"  class="form-control col-12 questionName" placeholder="Enter Your Question" style="width: 250px;">
                                                                        </div>
                                                                        <div class="form-group mb-2 ml-2 mr-2">

                                                                                <div class="dropdown"> <label class="mb-2">  Type </label>
                                                                                        <button class="btn btn-dropdown-toggle form-control btn-vf-quest-type" style="width:165px;" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                                                                                                aria-haspopup="true" aria-expanded="false">
                                                                                             <span class="qType" style="float:left;">Short Answer</span>
                                                                                             <i class="fa fa-angle-down icon_down pr-1" style="float:right;"></i>
                                                                                        </button>
                                                                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                                                            <a class="dropdown-item txt-btn ">Short Answer</a>
                                                                                            <a class="dropdown-item txtlong-btn ">Long Answer</a>
                              <a class="dropdown-item number-btn">Number</a>
                              <a class="dropdown-item file-btn">File upload</a>
                              <a class="dropdown-item date-btn">Date</a>
                              <a class="dropdown-item drp-btn" >Dropdown</a>
                              <a class="dropdown-item checkbox-btn" >CheckBox</a>
                                                                                        </div>
                                                                                </div>
                                                                        </div>`
            );
            if (qcount < 3) {
                // #jkdone
                data.push(
                    ` <div class="form-group mb-2 ml-2 mr-2 tag-class">

                                                                                     <div class="dropdown"> <label class="mb-2"> Tag </label>
                                                                                             <button class="btn btn-dropdown-toggle form-control btn-vf-quest-tag" style="width:165px;" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                                                                                                     aria-haspopup="true" aria-expanded="false">
                                                                                                    <span class="lead-type" style="float:left;">Tag</span>
                                                                                                    <i class="fa fa-angle-down icon_down pr-1" style="float:right;"></i>
                                                                                             </button>
                                                                                             <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                                                                     <a class="dropdown-item lead-type-name">Name</a>
                                                                                                     <a class="dropdown-item lead-type-email" >Email</a>
                                                                                                     <a class="dropdown-item lead-type-phone " >Phone</a>
                                                                                             </div>
                                                                                     </div>
                                                                             </div>`
                );
            }

            data.push(
                `<div class="form-group ml-2 mr-2">
                                                                                <label class="md-check mt-3">
                                                                                <input class=" qRequired" type="checkbox" >
                                                                                <i class="blue"></i>
                                                                                &nbsp;&nbsp;Required
                                                                                 </label>
                                                                        </div>


                                                                 <i class="fa  fa-trash-o trash-custom-input fa-md text-danger mt-2 ml-5 pointer delete-quest-vform" aria-hidden="true"></i>

                                                                </div>`
            );

            newData = data.join('')
            return newData;
        }

        $(document).on('click', ".number-btn, .file-btn, .date-btn", function() {
            $(this).parent().prev().children('.qType').text($(this).text());

        })
       
        $(document).on('click', ".txt-btn, .txtlong-btn", function() {
            console.log("hereeeee txt btn");
            $(this).parent().prev().children('.qType').text($(this).text());

            if ($(this).closest('.form-inline').children(".options").length > 0) {
                $(this).closest('.form-inline').children(".options").remove();
            }

        });
        $(document).on('click', ".lead-type-name, .lead-type-email, .lead-type-phone", function() {


            $(this).parent().prev().children('.lead-type').text($(this).text());



        });

        $(document).on('click', ".drp-btn", function() {

            $(this).parent().prev().children('.qType').text($(this).text());

            if ($(this).closest('.form-inline').children(".options").length == 0) {
                var optnData = makeOption();
                $(this).closest('.form-inline').append(optnData);
            }

        });

        $(document).on('click', ".checkbox-btn", function() {
            $(this).parent().prev().children('.qType').text($(this).text());

            if ($(this).closest('.form-inline').children(".options").length == 0) {
                var makeCheckBoxOptionData = makeCheckBoxOption();
                $(this).closest('.form-inline').append(makeCheckBoxOptionData);
            }

        })

        function makeOption() {

            var $data =
                `<div class="options ml-4" style="border-left:dashed 2px #41468D" >
                                                                <div class="option-list">
                                                                    <input type="text" class="custom_options mt-2 ml-2" placeholder="option"> <i class="fa  fa-remove remove-custom-options text-lg pointer ml-2" aria-hidden="true"></i><br>
                                                                </div>
                                                                 <button class="btn btn-link add-options-btn"> Add Option </button>
                                                         </div>`
            return $data;

        }
        function makeCheckBoxOption() {

            var $data =
                `<div class="options ml-4" style="border-left:dashed 2px #41468D" >
                                                                <div class="option-list-checkbox">
                                                                    <input type="text" class="custom_cehckbox_options mt-2 ml-2" placeholder="option"> <i class="fa  fa-remove remove-customCheckbox-options text-lg pointer ml-2" aria-hidden="true"></i><br>
                                                                </div>
                                                                 <button class="btn btn-link add-checkboxOptions-btn"> Add Option </button>
                                                         </div>`
            return $data;

        }

        $(document).on('click', ".trash-custom-input", function() {
            if ($(this).closest('.form-inline').next(".options")) {
                $(this).closest('.form-inline').next(".options").remove();
            }
            $(this).parent().remove();


        })

        $(document).on('click', ".remove-custom-options", function() {

            if ($(this).siblings('.custom_options').length > 1) {
                $(this).prev('.custom_options').remove();
                $(this).next('br').remove();
                $(this).remove();
            }

        });
        $(document).on('click', ".remove-customCheckbox-options", function() {

            if ($(this).siblings('.custom_cehckbox_options').length > 1) {
                $(this).prev('.custom_cehckbox_options').remove();
                $(this).next('br').remove();
                $(this).remove();
            }

        });

        $(document).on('click', ".add-options-btn", function() {

            var $optn = `<input type="text" name="" id="" class=" custom_options mt-2 ml-2" placeholder="option"> <i class="fa  fa-remove remove-custom-options text-lg pointer ml-2" aria-hidden="true"></i><br>`
            $(this).siblings('.option-list').append($optn);
        })

        $(document).on('click', ".add-checkboxOptions-btn", function() {

            var $optn = `<input type="text" name="" id="" class=" custom_cehckbox_options mt-2 ml-2" placeholder="option"> <i class="fa  fa-remove remove-customCheckbox-options text-lg pointer ml-2" aria-hidden="true"></i><br>`
            $(this).siblings('.option-list-checkbox').append($optn);
        })



        var customFormObj = {
            "user_id":user_id,
            "customFormData": []
        };

        $(document).on('click', ".create_custom_form", function() {
            customFormObj.customFormData = [];
            customFormObj.form_custom = true;
            customFormObj.form_enabled = false;
            customFormObj.coa_enabled = false;
            ajaxCall = true;

            if ($('#formHeading').val() == '') {
                ajaxCall = false;
                Swal.fire("Form heading is Empty!", "Provide Form Heading!", "warning");

            }
            customFormObj.form_custom_head = $('#formHeading').val();


            var farmBlack = $('#formBlock').children();
            for (let index = 0; index < farmBlack.length; index++) {

                var rString = randomString(10, '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ');
                var $dynamic = farmBlack.eq(index);
                const qName = $dynamic.children().find('.questionName').val();
                const qType = $dynamic.children().find('.qType').text();
                const leadType = $dynamic.children().find('.lead-type').text();
                const qRequired = $dynamic.children().find('.qRequired').is(':checked');

                console.log(leadType, "leadType");

                k = {
                    options: []
                };

                if (leadType) {

                    if (leadType != "Tag") {
                        k.leadType = leadType;
                    }

                }

                if (qName == '') {
                    ajaxCall = false;
                    Swal.fire("Question name is Empty!", "Provide Question Name!", "warning");
                    break;
                }
                k.qName = qName;
                k.qType = qType;
                k.qRequired = qRequired;
                k.id = rString;
                if (qType == "Dropdown") {

                    var options = $dynamic.children('.options');
                    otpnList = options.children().find('.custom_options');
                    console.log(otpnList.length, "otpnList")
                    for (let j = 0; j < otpnList.length; j++) {
                        if (otpnList[j].value == '') {
                            ajaxCall = false;
                            Swal.fire("Option is Empty!", "Provide Question Option!", "warning");
                            break;
                        }
                        k.options.push(otpnList[j].value);
                    }
                }else if( qType == "CheckBox" ){

                    var checkBoxOptions = $dynamic.children('.options');
                   let checkBoxOptnList = checkBoxOptions.children().find('.custom_cehckbox_options');

                   console.log(checkBoxOptnList.length, "<<<checkBoxOptnList")
                    for (let j = 0; j < checkBoxOptnList.length; j++) {
                        if (checkBoxOptnList[j].value == '') {
                            ajaxCall = false;
                            Swal.fire("Option is Empty!", "Provide Question Option!", "warning");
                            break;
                        }
                        k.options.push(checkBoxOptnList[j].value);
                    }

                }
                customFormObj.customFormData.push(k);

            }

         
            var leadTypes = [];
            for (let i = 0; i < customFormObj.customFormData.length; i++) {
                const element = customFormObj.customFormData[i];
                if (element.hasOwnProperty('leadType')) {
                    leadTypes.push(element.leadType);
                }
            }
            if (hasDuplicates(leadTypes) == true) {
                Swal.fire("Duplicate Tag Values!", "Tag your form fields uniquely!", "warning");
                ajaxCall = false;
            }

            function hasDuplicates(array) {
                return (new Set(array)).size !== array.length;
            }


            console.log(customFormObj, "<<<<<<<<custom Form Obj");

            if (ajaxCall) {

                $.ajax({
                    type: "PUT",
                    url: "/create-form",
                    data: customFormObj,
                    success: function(data) {
                        Swal.fire("Success!", "Your Custom Form Created", "success");
                        // window.location.reload();
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("textStatus: " + textStatus);
                        console.log("errorThrown: " + errorThrown);
                    }
                });
            }
        })

        function randomString(length, chars) {
            var result = '';
            for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];
            return result;
        }


        function renderEditForm() {

            console.log("heewwwww");
            customFormData = allWidgetData.form_custom_questions;

            $('#formHeading').val(allWidgetData.form_custom_head)
            formBlock = [];
            for (let i = 0; i < customFormData.length; i++) {
                const element = customFormData[i];
                formBlock.push(`<div class="form-inline mb-3 mt-3 newRowQuestVform">`);
                if (element.qType == 'Text') {
                    console.log("in if consdition");

                    formBlock.push(
                        `<div class="form-group mb-2 mr-2 ml-2">
                        <label class="mb-2">  Question ${i + 1}  </label>
                        <input type="text" value='${element.qName}'  class="form-control col-12 questionName"  placeholder="${element.qName}" style="width: 250px;">
                    </div>
                    <div class="form-group mb-2 ml-2 mr-2">
                      <div class="dropdown"><label class="mb-2">  Type </label>
                          <button class="btn btn-dropdown-toggle form-control btn-vf-quest-type" type="button " style="width:165px;" id="dropdownMenuButton" data-toggle="dropdown"
                                  aria-haspopup="true" aria-expanded="false">
                               <span class="qType" style="float:left;">${element.qType}</span>
                               <i class="fa fa-angle-down icon_down pr-1" style="float:right;"></i>
                          </button>
                          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <a class="dropdown-item txt-btn ">Short Answer</a>
                           <a class="dropdown-item txtlong-btn ">Long Answer</a>
                              <a class="dropdown-item number-btn">Number</a>
                              <a class="dropdown-item file-btn">File upload</a>
                              <a class="dropdown-item date-btn">Date</a>
                              <a class="dropdown-item drp-btn" >Dropdown</a>
                              <a class="dropdown-item checkbox-btn" >CheckBox</a>
                          </div>
                        </div>
                      </div>`
                    );

                    if (element.hasOwnProperty('leadType')) {
                        formBlock.push(
                            // #jkdone
                            ` <div class="form-group mb-2 ml-2 mr-2 tag-class">

                                                                                     <div class="dropdown"> <label class="mb-2"> Tag </label>
                                                                                             <button class="btn btn-dropdown-toggle form-control btn-vf-quest-tag" type="button" style="width:165px;" id="dropdownMenuButton" data-toggle="dropdown"
                                                                                                     aria-haspopup="true" aria-expanded="false">
                                                                                                    <span class="lead-type" style="float:left;">${element.leadType}</span>
                                                                                                    <i class="fa fa-angle-down icon_down pr-1" style="float:right;"></i>

                                                                                             </button>
                                                                                             <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                                                                     <a class="dropdown-item lead-type-name">Name</a>
                                                                                                     <a class="dropdown-item lead-type-email" >Email</a>
                                                                                                     <a class="dropdown-item lead-type-phone " >Phone</a>
                                                                                             </div>
                                                                                     </div>
                                                                             </div>`
                        );
                    }
                    formBlock.push(
                        `<div class="form-group ml-2 mr-2">
                                                                                <label class="md-check mt-3">
                                                                                <input class="qRequired" type="checkbox" >
                                                                                <i class="blue"></i>
                                                                                &nbsp;&nbsp;Required
                                                                                 </label>
                                                                        </div>
                                                                        <i class="fa  fa-trash-o trash-custom-input text-danger mt-2 ml-5 pointer delete-quest-vform" aria-hidden="true"></i>`
                    );
                } else {
                    console.log("in else consdition");
                    formBlock.push(
                        `<div class="form-group ml-2 mr-2 ">
                                                                        <label class="mb-2">  Question ${i + 1}  </label>
                                                                            <input type="text" value='${element.qName}'  class="form-control col-12 questionName"  placeholder="${element.qName}">
                                                                        </div>
                                                                        <div class="form-group mx-sm-3 mb-2 mr-4 ml-4">
                                                                                <div class="dropdown"><label class="mb-2">Type</label>
                                                                                        <button class="btn btn-dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                                                                                                aria-haspopup="true" aria-expanded="false">
                                                                                             <span class="qType" style="float:left;">${element.qType}</span>
                                                                                             <i class="fa fa-angle-down icon_down pr-1" style="float:right;"></i>
                                                                                        </button>
                                                                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                                                              <a class="dropdown-item txt-btn ">Short Answer</a>
                           <a class="dropdown-item txtlong-btn ">Long Answer</a>
                              <a class="dropdown-item number-btn">Number</a>
                              <a class="dropdown-item file-btn">File upload</a>
                              <a class="dropdown-item date-btn">Date</a>
                              <a class="dropdown-item drp-btn" >Dropdown</a>
                              <a class="dropdown-item checkbox-btn" >CheckBox</a>
                                                                                        </div>
                                                                                </div>
                                                                        </div>
                                                                        <div class="form-group mr-4 ml-4">
                                                                                <label class="md-check mt-3">
                                                                                <input class=" qRequired" type="checkbox" >
                                                                                <i class="blue"></i>
                                                                                &nbsp;&nbsp;Required
                                                                                 </label>
                                                                        </div>
                                                                        <i class="fa  fa-trash-o trash-custom-input text-danger mt-2 ml-5 pointer delete-quest-vform" aria-hidden="true"></i>`
                    );
                    formBlock.push(` <div class="options ml-4" style="border-left:dashed  2px #41468D" >
                                                                <div class="option-list">`);
                    for (let k = 0; k < element.options.length; k++) {
                        const data = element.options[k];
                        formBlock.push(` <input type="text" value="${data}" class="form-control custom_options mt-2 ml-2" placeholder="option"> <i class="fa  fa-remove remove-custom-options text-lg pointer ml-3" aria-hidden="true"></i><br>`);
                    }
                    formBlock.push(`</div><button class="btn btn-link add-options-btn"> Add Option </button></div>`);

                }
                formBlock.push(`</div>`);
            }
            formView = formBlock.join('');
            document.querySelector("#formBlock").innerHTML = formView;


            var farmBlack2 = $('#formBlock').children();
            for (let i = 0; i < customFormData.length; i++) {
                const element = customFormData[i];
                var $dynamic = farmBlack2.eq(i);

                if (element.qRequired == "true") {

                    $dynamic.children().find('.qRequired').prop('checked', true);
                }
                console.log(element, "eleeeeeeeee");
                //   $dynamic.children().find('.qRequired').is(':checked');
            }


        }
    </script>
    <script>


        $('#addNewWeb').click(function() {
            console.log("reached 1");
            var websiteName = $('#newSiteName').val();
            var websiteUrl = $('#newSiteUrl').val();
            if (websiteName == '') {

                Swal.fire("Website Name Missing!", "Please enter website name", "warning");

            } else if (websiteUrl == '') {

                Swal.fire("Website URL Missing!", "Please enter website Url", "warning");

            } else {

                var dataObj = {
                    "name": websiteName,
                    "url": websiteUrl
                };
                console.log(dataObj, "dataObj 2");
                createWebsite(dataObj);
            }

        })

        function createWebsite(dataObj) {
            $.ajax({
                type: "POST",
                url: "/createWebsite",
                data: dataObj,
                success: function(msg) {

                    console.log("Data Saved: " + msg);
                    console.log("web site created succesfully");
                    Swal.fire("Success!", "Website Created Successfully", "success");
                    $('.onboarding-modal').modal('hide');
                    location.reload();
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    Swal.fire("Ooops!", "Something wrong occured!", "warning")

                    console.log("textStatus: " + textStatus);
                    console.log("errorThrown: " + errorThrown);
                }
            });

        }
    </script>
</body>

</html>
